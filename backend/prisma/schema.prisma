// Inventory Pro - Warehouse Management System
// Movement-based inventory architecture with price snapshots

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE ENTITIES (Multi-Tenancy & Auth)
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  address   String?
  phone     String?
  email     String?
  settings  Json?    // Organization-specific settings
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  users            User[]
  warehouses       Warehouse[]
  products         Product[]
  categories       Category[]
  customers        Customer[]
  suppliers        Supplier[]
  salesOrders      SalesOrder[]
  purchaseOrders   PurchaseOrder[]
  stockTransfers   StockTransfer[]
  stockAdjustments StockAdjustment[]
  stockOpnames     StockOpname[]

  subscription     Subscription?

  @@map("organizations")
}

// ============================================
// SUBSCRIPTION & BILLING
// ============================================

model Plan {
  id            String   @id @default(cuid())
  name          String   @unique // Free, Basic, Pro, Enterprise
  slug          String   @unique
  description   String?
  priceMonthly  Decimal  @db.Decimal(12, 2)
  priceYearly   Decimal  @db.Decimal(12, 2)
  limits        Json     // { maxUsers: 5, maxWarehouses: 1, maxItems: 100 }
  features      Json     // ["advanced_reports", "api_access"]
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  subscriptions Subscription[]

  @@map("plans")
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  EXPIRED
  INCOMPLETE
}

model Subscription {
  id             String             @id @default(cuid())
  organizationId String             @unique
  planId         String
  status         SubscriptionStatus @default(ACTIVE)
  startDate      DateTime           @default(now())
  endDate        DateTime?
  trialEndDate   DateTime?
  billingCycle   String             @default("monthly") // monthly, yearly
  paymentProvider String?           // stripe, midtrans, manual
  paymentRefId    String?           // subscription ID from provider
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan         Plan         @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // SuperAdmin, Admin, Manager, Staff, Viewer
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users           User[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "inventory:create", "inventory:read"
  resource    String   // e.g., "inventory", "sales-orders"
  action      String   // e.g., "create", "read", "update", "delete"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String
  password       String
  roleId         String
  organizationId String?   // Null for SuperAdmin
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?
  preferences    Json?     // { notifications: { lowStock: boolean, ... } }

  role         Role          @relation(fields: [roleId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id])

  createdProducts         Product[]             @relation("ProductCreatedBy")
  updatedProducts         Product[]             @relation("ProductUpdatedBy")
  createdSalesOrders      SalesOrder[]          @relation("SalesOrderCreatedBy")
  createdPurchaseOrders   PurchaseOrder[]       @relation("PurchaseOrderCreatedBy")
  createdStockAdjustments StockAdjustment[]     @relation("StockAdjustmentCreatedBy")
  createdStockTransfers   StockTransfer[]       @relation("StockTransferCreatedBy")
  inventoryMovements      InventoryMovement[]   @relation("InventoryMovementCreatedBy")
  createdStockOpnames     StockOpname[]         @relation("StockOpnameCreatedBy")
  priceChanges            ProductPriceHistory[] // history perubahan harga yang dibuat user ini

  @@index([organizationId])
  @@index([roleId])
  @@map("users")
}

// ============================================
// PRODUCT CATALOG
// ============================================

model Category {
  id             String    @id @default(cuid())
  name           String
  description    String?
  organizationId String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  products     Product[]

  @@index([organizationId])
  @@map("categories")
}

// Jenis harga yang disimpan di history
enum PriceType {
  SELLING
  COST
}

model Product {
  id                String    @id @default(cuid())
  name              String
  sku               String
  barcode           String?
  description       String?
  categoryId        String?
  supplierId        String?
  unit              String    @default("pcs") // pcs, kg, liter, box, etc.
  sellingPrice      Decimal   @db.Decimal(12, 2) // Current selling price (cache)
  costPrice         Decimal   @db.Decimal(12, 2) // Current cost price (cache)
  lowStockThreshold Int       @default(10)
  customAttributes  Json?     // Flexible attributes (size, color, brand, etc.)
  organizationId    String
  createdById       String
  updatedById       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category     Category?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  supplier     Supplier?    @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  createdBy    User         @relation("ProductCreatedBy", fields: [createdById], references: [id])
  updatedBy    User?        @relation("ProductUpdatedBy", fields: [updatedById], references: [id])

  images              ProductImage[]
  inventoryItems      InventoryItem[]
  inventoryMovements  InventoryMovement[]
  salesOrderItems     SalesOrderItem[]
  purchaseOrderItems  PurchaseOrderItem[]
  stockTransferItems  StockTransferItem[]
  stockAdjustments    StockAdjustment[]
  stockOpnameItems    StockOpnameItem[]
  priceHistory        ProductPriceHistory[]  // history semua perubahan harga

  @@unique([organizationId, sku])
  @@index([organizationId])
  @@index([categoryId])
  @@map("products")
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  alt       String?
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

// History harga per product
model ProductPriceHistory {
  id          String    @id @default(cuid())
  productId   String
  priceType   PriceType
  price       Decimal   @db.Decimal(12, 2)
  currency    String    @default("IDR")
  effectiveAt DateTime  @default(now())
  notes       String?
  createdById String
  createdAt   DateTime  @default(now())

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdBy User    @relation(fields: [createdById], references: [id])

  @@index([productId, priceType, effectiveAt])
  @@map("product_price_history")
}

// ============================================
// INVENTORY (Movement-Based Architecture)
// ============================================

model Warehouse {
  id             String    @id @default(cuid())
  name           String
  code           String
  address        String?
  city           String?
  phone          String?
  isActive       Boolean   @default(true)
  organizationId String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  inventoryItems         InventoryItem[]
  inventoryMovements     InventoryMovement[]
  salesOrders            SalesOrder[]
  purchaseOrders         PurchaseOrder[]
  stockTransfersFrom     StockTransfer[]     @relation("TransferFrom")
  stockTransfersTo       StockTransfer[]     @relation("TransferTo")
  stockAdjustments       StockAdjustment[]
  stockOpnames           StockOpname[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@map("warehouses")
}

// Current on-hand stock per product per warehouse (computed/maintained field)
model InventoryItem {
  id             String   @id @default(cuid())
  productId      String
  warehouseId    String
  quantityOnHand Int      @default(0) // Current stock (derived from movements)
  allocatedQty   Int      @default(0) // Reserved for confirmed sales orders
  availableQty   Int      @default(0) // quantityOnHand - allocatedQty
  updatedAt      DateTime @updatedAt

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([productId, warehouseId])
  @@index([warehouseId])
  @@index([productId])
  @@map("inventory_items")
}

enum MovementType {
  IN           // Purchase receipt, transfer in
  OUT          // Sales fulfillment, transfer out
  ADJUST       // Manual adjustment
  TRANSFER_OUT // Stock transfer out
  TRANSFER_IN  // Stock transfer in
}

// Append-only audit log of all stock changes
model InventoryMovement {
  id            String       @id @default(cuid())
  productId     String
  warehouseId   String
  movementType  MovementType
  quantity      Int          // Positive for IN, negative for OUT
  referenceType String?      // "SalesOrder", "PurchaseOrder", "StockAdjustment", "StockTransfer"
  referenceId   String?      // ID of the source document
  notes         String?
  createdById   String
  createdAt     DateTime     @default(now())

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  createdBy User      @relation("InventoryMovementCreatedBy", fields: [createdById], references: [id])

  @@index([productId])
  @@index([warehouseId])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@map("inventory_movements")
}

enum AdjustmentReason {
  DAMAGE
  LOST
  FOUND
  AUDIT
  CORRECTION
  EXPIRED
  OTHER
}

model StockAdjustment {
  id             String           @id @default(cuid())
  productId      String
  warehouseId    String
  adjustmentType String           // "increase" or "decrease"
  quantity       Int
  reason         AdjustmentReason
  notes          String?
  reference      String?          // Optional reference number
  organizationId String
  createdById    String
  createdAt      DateTime         @default(now())

  product      Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse    Warehouse    @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("StockAdjustmentCreatedBy", fields: [createdById], references: [id])

  @@index([organizationId])
  @@index([productId])
  @@index([warehouseId])
  @@map("stock_adjustments")
}

// ============================================
// CUSTOMERS & SUPPLIERS
// ============================================

model Customer {
  id             String    @id @default(cuid())
  name           String
  email          String?
  phone          String?
  address        String?
  city           String?
  taxId          String?
  notes          String?
  organizationId String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesOrders  SalesOrder[]

  @@index([organizationId])
  @@map("customers")
}

model Supplier {
  id             String    @id @default(cuid())
  name           String
  email          String?
  phone          String?
  address        String?
  city           String?
  taxId          String?
  notes          String?
  organizationId String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]
  products       Product[]

  @@index([organizationId])
  @@map("suppliers")
}

// ============================================
// SALES ORDERS (with Price Snapshots)
// ============================================

enum SalesOrderStatus {
  DRAFT
  CONFIRMED
  FULFILLED
  INVOICED
  CANCELLED
}

model SalesOrder {
  id             String            @id @default(cuid())
  orderNumber    String            @unique
  customerId     String?
  warehouseId    String            // Fulfillment warehouse
  status         SalesOrderStatus  @default(DRAFT)
  orderDate      DateTime          @default(now())
  notes          String?
  subtotal       Decimal           @db.Decimal(12, 2)
  tax            Decimal           @default(0) @db.Decimal(12, 2)
  discount       Decimal           @default(0) @db.Decimal(12, 2)
  total          Decimal           @db.Decimal(12, 2)
  organizationId String
  createdById    String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  customer     Customer?    @relation(fields: [customerId], references: [id])
  warehouse    Warehouse    @relation(fields: [warehouseId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("SalesOrderCreatedBy", fields: [createdById], references: [id])
  items        SalesOrderItem[]

  @@index([organizationId])
  @@index([customerId])
  @@index([status])
  @@map("sales_orders")
}

// Line items with price snapshot (price at time of order)
model SalesOrderItem {
  id           String  @id @default(cuid())
  salesOrderId String
  productId    String
  quantity     Int
  unitPrice    Decimal @db.Decimal(12, 2) // Price snapshot
  discount     Decimal @default(0) @db.Decimal(12, 2)
  lineTotal    Decimal @db.Decimal(12, 2) // (quantity * unitPrice) - discount

  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id])

  @@index([salesOrderId])
  @@index([productId])
  @@map("sales_order_items")
}

// ============================================
// PURCHASE ORDERS (with Cost Snapshots)
// ============================================

enum PurchaseOrderStatus {
  DRAFT
  SENT
  PARTIALLY_RECEIVED
  COMPLETED
  CANCELLED
}

model PurchaseOrder {
  id             String              @id @default(cuid())
  poNumber       String              @unique
  supplierId     String
  warehouseId    String              // Destination warehouse
  status         PurchaseOrderStatus @default(DRAFT)
  orderDate      DateTime            @default(now())
  expectedDate   DateTime?
  notes          String?
  subtotal       Decimal             @db.Decimal(12, 2)
  tax            Decimal             @default(0) @db.Decimal(12, 2)
  total          Decimal             @db.Decimal(12, 2)
  organizationId String
  createdById    String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  supplier     Supplier     @relation(fields: [supplierId], references: [id])
  warehouse    Warehouse    @relation(fields: [warehouseId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("PurchaseOrderCreatedBy", fields: [createdById], references: [id])
  items        PurchaseOrderItem[]
  receipts     PurchaseReceipt[]

  @@index([organizationId])
  @@index([supplierId])
  @@index([status])
  @@map("purchase_orders")
}

// Line items with cost snapshot (cost at time of PO)
model PurchaseOrderItem {
  id              String  @id @default(cuid())
  purchaseOrderId String
  productId       String
  quantity        Int
  unitCost        Decimal @db.Decimal(12, 2) // Cost snapshot
  lineTotal       Decimal @db.Decimal(12, 2) // quantity * unitCost
  receivedQty     Int     @default(0)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])

  @@index([purchaseOrderId])
  @@index([productId])
  @@map("purchase_order_items")
}

model PurchaseReceipt {
  id              String   @id @default(cuid())
  purchaseOrderId String
  receiptNumber   String   @unique
  receivedDate    DateTime @default(now())
  notes           String?
  receivedItems   Json     // Array of {productId, quantity}
  createdAt       DateTime @default(now())

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@map("purchase_receipts")
}

// ============================================
// STOCK TRANSFERS
// ============================================

enum StockTransferStatus {
  DRAFT
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

model StockTransfer {
  id             String              @id @default(cuid())
  transferNumber String              @unique
  fromWarehouseId String
  toWarehouseId   String
  status          StockTransferStatus @default(DRAFT)
  transferDate    DateTime            @default(now())
  completedDate   DateTime?
  notes           String?
  organizationId  String
  createdById     String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  fromWarehouse Warehouse    @relation("TransferFrom", fields: [fromWarehouseId], references: [id])
  toWarehouse   Warehouse    @relation("TransferTo", fields: [toWarehouseId], references: [id])
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy     User         @relation("StockTransferCreatedBy", fields: [createdById], references: [id])
  items         StockTransferItem[]

  @@index([organizationId])
  @@index([status])
  @@map("stock_transfers")
}


model StockTransferItem {
  id              String  @id @default(cuid())
  stockTransferId String
  productId       String
  quantity        Int

  stockTransfer StockTransfer @relation(fields: [stockTransferId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])

  @@index([stockTransferId])
  @@index([productId])
  @@map("stock_transfer_items")
}

// ============================================
// STOCK OPNAME (Physical Count)
// ============================================

enum StockOpnameStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model StockOpname {
  id             String            @id @default(cuid())
  opnameNumber   String            @unique
  warehouseId    String
  status         StockOpnameStatus @default(DRAFT)
  date           DateTime          @default(now())
  notes          String?
  organizationId String
  createdById    String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  warehouse    Warehouse         @relation(fields: [warehouseId], references: [id])
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User              @relation("StockOpnameCreatedBy", fields: [createdById], references: [id])
  items        StockOpnameItem[]

  @@index([organizationId])
  @@index([warehouseId])
  @@index([status])
  @@map("stock_opnames")
}

model StockOpnameItem {
  id        String @id @default(cuid())
  opnameId  String
  productId String
  systemQty Int // Qty recorded in system at start of opname
  actualQty Int? // Qty counted physically
  difference Int? // actualQty - systemQty (computed)

  opname  StockOpname @relation(fields: [opnameId], references: [id], onDelete: Cascade)
  product Product     @relation(fields: [productId], references: [id])

  @@index([opnameId])
  @@index([productId])
  @@map("stock_opname_items")
}

// ============================================
// INFRASTRUCTURE & READ MODELS
// ============================================

model OutboxEvent {
  id             String   @id @default(cuid())
  organizationId String
  topic          String   // e.g., "inventory.movement.created"
  payload        Json
  status         String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  attempts       Int      @default(0)
  lastError      String?
  createdAt      DateTime @default(now())
  processedAt    DateTime?

  @@index([organizationId])
  @@index([status, createdAt])
  @@map("outbox_events")
}

// Denormalized Read Model for performance
model StockSummary {
  id             String   @id @default(cuid())
  organizationId String
  warehouseId    String
  productId      String
  totalIn        Int      @default(0)
  totalOut       Int      @default(0)
  currentStock   Int      @default(0)
  lastMovementAt DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, warehouseId, productId])
  @@index([organizationId, warehouseId])
  @@map("stock_summaries")
}

