// proxy.ts (atau middleware.ts)
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import NextAuth from 'next-auth';
import { authConfig } from '@/lib/auth.config';
import createMiddleware from 'next-intl/middleware';

const { auth } = NextAuth(authConfig);

import { routing } from './i18n/routing';

const intlMiddleware = createMiddleware(routing);

// Semua path yang harus pakai login
const PROTECTED_PATHS = [
    '/dashboard',
    '/inventory',
    '/warehouses',
    '/sales-orders',
    '/purchase-orders',
    '/transfers',
    '/adjustments',
    '/customers',
    '/suppliers',
    '/settings',
    '/superadmin'
];

// Cek apa route ini butuh proteksi, pakai path TANPA prefix locale
function isProtectedRoute(pathname: string): boolean {
    // Normalize: buang prefix locale /en /id kalau ada
    const localeMatch = pathname.match(/^\/(en|id)(\/.*)?$/);
    if (localeMatch) {
        pathname = localeMatch[2] || '/';
    }

    return PROTECTED_PATHS.some(
        (base) => pathname === base || pathname.startsWith(`${base}/`)
    );
}

export default async function proxy(request: NextRequest) {
    const url = request.nextUrl.clone();
    const { pathname } = url;

    // 1️⃣ Proteksi route berdasarkan path tanpa locale
    if (isProtectedRoute(pathname)) {
        const session = await auth();

        if (!session?.user) {
            const loginUrl = new URL('/login', request.url); // selalu ke /login (tanpa locale)
            loginUrl.searchParams.set('callbackUrl', pathname);
            return NextResponse.redirect(loginUrl);
        }
    }

    // 2️⃣ Serahkan ke next-intl (dia akan handle rewrite / -> /id dan redirect /id -> /)
    return intlMiddleware(request);
}

// 5️⃣ Middleware diapply ke semua halaman non-API/non-static
export const config = {
    matcher: ['/((?!api|_next|.*\\..*).*)']
};
